<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<div th:fragment="fragment-tech(tech)" class="form-floating">
    <!-- 태그 라이브러리 -->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.15.2/js/selectize.min.js" integrity="sha512-IOebNkvA/HZjMM7MxL0NYeLYEalloZ8ckak+NDtOViP7oiYzG5vn6WVXyrJDiJPhl4yRdmNAG49iuLmhkUdVsQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.15.2/css/selectize.bootstrap5.min.css" integrity="sha512-Ars0BmSwpsUJnWMw+KoUKGKunT7+T8NGK0ORRKj+HT8naZzLSIQoOSIIM3oyaJljgLxFi0xImI5oZkAWEFARSA==" crossorigin="anonymous" referrerpolicy="no-referrer" />-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.14.0/js/selectize.min.js" integrity="sha512-VReIIr1tJEzBye8Elk8Dw/B2dAUZFRfxnV2wbpJ0qOvk57xupH+bZRVHVngdV04WVrjaMeR1HfYlMLCiFENoKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.14.0/css/selectize.bootstrap5.min.css" integrity="sha512-gPfqgXe/pl1EpOS++KmVkF5Ca6C/Kj/4K/bt+n9nt6FkkeralgnL2907thbVEmYhacdqChfgw8XTlyCh2be4+A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- 태그 라이브러리 -->


    <script th:inline="javascript">
        //var tagify;
        //$(document).ready(function() {
        //    var inputElem = document.querySelector('input[name=tech]');
        //    tagify = new Tagify(inputElem);
        //    tagify.addTags();
        //});

        let beforeTagInputText = '';
        let beforeTagInputId = 0;
        const loadDelay = 0.3;
        let tagLoadTimer;
        let $select;

        $(document).ready(function() {
            $select = $('#input-tech').selectize({
              create: true,
              create: function(input, callback) {
                if(input === beforeTagInputText)
                    return;
                beforeTagInputText = input;
                $.ajax({
                    url: '/api/tech',
                    type: 'POST',
                    data: JSON.stringify({"techName": input}),
                    contentType: 'application/json',
                    success: function(response) {
                        callback({value:response, text:input});
                    },
                });
              },
              load: function(query, callback) {
                if (query.length < 2) return callback();
                clearTimeout(tagLoadTimer);

                tagLoadTimer = setTimeout(function() {
                    $.ajax({
                        url: `/api/tech?name=${encodeURIComponent(query)}`,
                        type: 'GET',
                        contentType: 'application/json',
                        success: function (response) {
                            const convertResult = response.map(item => {
                                return {"value": item.id, "text": item.name};
                            });
                            callback(convertResult);
                        },
                        error: function () {
                            callback();
                        }
                    });
                }, loadDelay);
              },
            });

            const initTech = [[${tech}]];
            if(initTech !== null)
                initTech.forEach(item => {
                    showItem(id=item.id, vale=item.value);
                });
        });

        function showItem(id, value) {
            console.log("bbb?" + id +" : " + value);
            $select[0].selectize.addOption({"value": id, "text": value});
            $select[0].selectize.addItem(id);
        }
    </script>
    <div>
        <label class="col-form-label me-2">관련 기술</label>
        <input name="tech" id="tech" placeholder="기술 입력 후 'Enter'">
    </div>

    <div class="control-group">
        <label for="input-tech">관련 기술</label>
        <input type="text" name="input-tech" id="input-tech" class="demo-default" style="text-transform:uppercase">
    </div>

</div>
</html>